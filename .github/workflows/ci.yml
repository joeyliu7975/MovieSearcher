name: CI

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    name: Build and Test
    runs-on: macos-14
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable
      
      - name: Show Xcode version
        run: xcodebuild -version
      
      - name: Show available simulators
        run: xcrun simctl list devices available | grep -i "iphone 16" || true
      
      - name: Cache DerivedData
        uses: actions/cache@v4
        with:
          path: ~/Library/Developer/Xcode/DerivedData
          key: ${{ runner.os }}-deriveddata-${{ hashFiles('MovieSearcher/**/*.pbxproj') }}
          restore-keys: |
            ${{ runner.os }}-deriveddata-
      
      - name: Build project
        working-directory: MovieSearcher
        env:
          TMDB_API_KEY: ${{ secrets.TMDB_API_KEY }}
          TMDB_READ_ACCESS_TOKEN: ${{ secrets.TMDB_READ_ACCESS_TOKEN }}
          TMDB_ACCOUNT_ID: ${{ secrets.TMDB_ACCOUNT_ID }}
        run: |
          xcodebuild clean build \
            -scheme MovieSearcher \
            -destination 'platform=iOS Simulator,name=iPhone 16,OS=latest' \
            -sdk iphonesimulator \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO
      
      - name: Run Unit Tests
        working-directory: MovieSearcher
        env:
          TMDB_API_KEY: ${{ secrets.TMDB_API_KEY }}
          TMDB_READ_ACCESS_TOKEN: ${{ secrets.TMDB_READ_ACCESS_TOKEN }}
          TMDB_ACCOUNT_ID: ${{ secrets.TMDB_ACCOUNT_ID }}
        run: |
          xcodebuild test \
            -scheme MovieSearcher \
            -destination 'platform=iOS Simulator,name=iPhone 16,OS=latest' \
            -only-testing:MovieSearcherTests \
            -sdk iphonesimulator \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            -enableCodeCoverage YES \
            -resultBundlePath TestResults.xcresult
      
      - name: Prepare simulator for UI tests
        run: |
          echo "ðŸ”§ Preparing simulator..."
          # Shutdown all simulators to avoid conflicts
          xcrun simctl shutdown all || true
          # Wait a bit for simulators to fully shutdown
          sleep 3
          echo "âœ… Simulator preparation complete"
      
      - name: Run UI Tests
        working-directory: MovieSearcher
        timeout-minutes: 30
        continue-on-error: true
        env:
          TMDB_API_KEY: ${{ secrets.TMDB_API_KEY }}
          TMDB_READ_ACCESS_TOKEN: ${{ secrets.TMDB_READ_ACCESS_TOKEN }}
          TMDB_ACCOUNT_ID: ${{ secrets.TMDB_ACCOUNT_ID }}
        run: |
          xcodebuild test \
            -scheme MovieSearcher \
            -destination 'platform=iOS Simulator,name=iPhone 16,OS=latest' \
            -only-testing:MovieSearcherUITests \
            -skip-testing:MovieSearcherUITests/MovieSearcherUITests/testLaunchPerformance \
            -sdk iphonesimulator \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            -enableCodeCoverage YES \
            -resultBundlePath UITestResults.xcresult \
            -test-timeouts-enabled YES \
            -maximum-test-execution-time-allowance 180 \
            -maximum-concurrent-test-simulator-destinations 1 2>&1 | tee test-output.log || UI_TEST_EXIT_CODE=$?
          
          # Always exit with the test result code
          exit ${UI_TEST_EXIT_CODE:-0}
      
      - name: Parse and Display Test Failures
        if: always()
        working-directory: MovieSearcher
        run: |
          echo "ðŸ” Analyzing UI test results..."
          echo ""
          
          # Check if result file exists
          if [ ! -d "UITestResults.xcresult" ]; then
            echo "âŒ Test results file not found!"
            echo "This usually means tests didn't start properly."
            echo ""
            echo "=== Last 50 lines of test output ==="
            tail -50 test-output.log 2>/dev/null || echo "No test output log found"
            exit 0
          fi
          
          echo "=== Test Results Analysis ==="
          echo ""
          
          # Extract basic test summary from log file
          echo "ðŸ“Š Test Summary:"
          if [ -f "test-output.log" ]; then
            echo ""
            echo "=== Test Execution Summary from Log ==="
            PASSED_COUNT=$(grep -c "Test case.*passed" test-output.log 2>/dev/null || echo "0")
            FAILED_COUNT=$(grep -c "Test case.*failed" test-output.log 2>/dev/null || echo "0")
            TOTAL_COUNT=$((PASSED_COUNT + FAILED_COUNT))
            
            echo "âœ… Passed Tests: $PASSED_COUNT"
            echo "âŒ Failed Tests: $FAILED_COUNT"
            echo "ðŸ“Š Total: $TOTAL_COUNT tests"
            echo ""
            
            if [ "$FAILED_COUNT" -gt 0 ]; then
              echo "=== Failed Test Cases ==="
              grep "Test case.*failed" test-output.log | sed 's/.*Test case //' | sed 's/ failed.*//' | head -20
              echo ""
            fi
            
            if [ "$PASSED_COUNT" -gt 0 ]; then
              echo "=== Passed Test Cases (first 10) ==="
              grep "Test case.*passed" test-output.log | sed 's/.*Test case //' | sed 's/ passed.*//' | head -10
              echo ""
            fi
          else
            echo "âš ï¸  Test output log not found"
          fi

          echo ""
          echo "=== Searching for Error Patterns in Log ==="
          if [ -f "test-output.log" ]; then
            echo ""
            echo "Key error patterns found:"
            grep -i -E "(error|fail|timeout|assert|exception)" test-output.log | head -20 || echo "No obvious error patterns found"
          fi
          
          echo ""
          echo "ðŸ“¥ For detailed analysis:"
          echo "   1. Download the 'ui-test-results' artifact"
          echo "   2. Extract UITestResults.xcresult"
          echo "   3. Open it in Xcode (double-click) to see full details, screenshots, and logs"
      
      - name: Generate Test Summary
        if: always()
        working-directory: MovieSearcher
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## ðŸ§ª UI Test Results
          
          EOF
          
          if [ -d "UITestResults.xcresult" ]; then
            echo "âœ… Test results file generated" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Extract summary from log if available
            if [ -f "test-output.log" ]; then
              PASSED_COUNT=$(grep -c "Test case.*passed" test-output.log 2>/dev/null || echo "0")
              FAILED_COUNT=$(grep -c "Test case.*failed" test-output.log 2>/dev/null || echo "0")
              
              echo "### Test Statistics" >> $GITHUB_STEP_SUMMARY
              echo "- âœ… Passed: $PASSED_COUNT" >> $GITHUB_STEP_SUMMARY
              echo "- âŒ Failed: $FAILED_COUNT" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              
              if [ "$FAILED_COUNT" -gt 0 ]; then
                echo "### Failed Tests" >> $GITHUB_STEP_SUMMARY
                echo '```' >> $GITHUB_STEP_SUMMARY
                grep "Test case.*failed" test-output.log | sed 's/.*Test case //' | sed 's/ failed.*//' | head -20 >> $GITHUB_STEP_SUMMARY
                echo '```' >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
              fi
            fi
            
            echo "### Download Results" >> $GITHUB_STEP_SUMMARY
            echo "Download the \`ui-test-results\` artifact and open \`UITestResults.xcresult\` in Xcode for detailed analysis." >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Test results file not found" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Tests may not have started properly. Check the logs above for errors." >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Upload Unit Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-results
          path: MovieSearcher/TestResults.xcresult
          retention-days: 30
          if-no-files-found: ignore
      
      - name: Upload UI Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ui-test-results
          path: |
            MovieSearcher/UITestResults.xcresult
            MovieSearcher/test-output.log
          retention-days: 30
          if-no-files-found: ignore
      
      - name: Cleanup simulators
        if: always()
        run: |
          echo "ðŸ§¹ Cleaning up simulators..."
          xcrun simctl shutdown all || true
          echo "âœ… Cleanup complete"
