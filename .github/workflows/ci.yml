name: CI

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    name: Build and Test
    runs-on: macos-14
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable
      
      - name: Show Xcode version
        run: xcodebuild -version
      
      - name: Show available simulators
        run: xcrun simctl list devices available | grep -i "iphone 16" || true
      
      - name: Cache DerivedData
        uses: actions/cache@v4
        with:
          path: ~/Library/Developer/Xcode/DerivedData
          key: ${{ runner.os }}-deriveddata-${{ hashFiles('MovieSearcher/**/*.pbxproj') }}
          restore-keys: |
            ${{ runner.os }}-deriveddata-
      
      - name: Build project
        working-directory: MovieSearcher
        env:
          TMDB_API_KEY: ${{ secrets.TMDB_API_KEY }}
          TMDB_READ_ACCESS_TOKEN: ${{ secrets.TMDB_READ_ACCESS_TOKEN }}
          TMDB_ACCOUNT_ID: ${{ secrets.TMDB_ACCOUNT_ID }}
        run: |
          xcodebuild clean build \
            -scheme MovieSearcher \
            -destination 'platform=iOS Simulator,name=iPhone 16,OS=latest' \
            -sdk iphonesimulator \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO
      
      - name: Run Unit Tests
        working-directory: MovieSearcher
        env:
          TMDB_API_KEY: ${{ secrets.TMDB_API_KEY }}
          TMDB_READ_ACCESS_TOKEN: ${{ secrets.TMDB_READ_ACCESS_TOKEN }}
          TMDB_ACCOUNT_ID: ${{ secrets.TMDB_ACCOUNT_ID }}
        run: |
          xcodebuild test \
            -scheme MovieSearcher \
            -destination 'platform=iOS Simulator,name=iPhone 16,OS=latest' \
            -only-testing:MovieSearcherTests \
            -sdk iphonesimulator \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            -enableCodeCoverage YES \
            -resultBundlePath TestResults.xcresult
      
      - name: Prepare simulator for UI tests
        run: |
          echo "ðŸ”§ Preparing simulator..."
          # Shutdown all simulators to avoid conflicts
          xcrun simctl shutdown all || true
          # Wait a bit for simulators to fully shutdown
          sleep 3
          echo "âœ… Simulator preparation complete"
      
      - name: Run UI Tests
        working-directory: MovieSearcher
        timeout-minutes: 30
        continue-on-error: true
        env:
          TMDB_API_KEY: ${{ secrets.TMDB_API_KEY }}
          TMDB_READ_ACCESS_TOKEN: ${{ secrets.TMDB_READ_ACCESS_TOKEN }}
          TMDB_ACCOUNT_ID: ${{ secrets.TMDB_ACCOUNT_ID }}
        run: |
          xcodebuild test \
            -scheme MovieSearcher \
            -destination 'platform=iOS Simulator,name=iPhone 16,OS=latest' \
            -only-testing:MovieSearcherUITests \
            -skip-testing:MovieSearcherUITests/MovieSearcherUITests/testLaunchPerformance \
            -sdk iphonesimulator \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            -enableCodeCoverage YES \
            -resultBundlePath UITestResults.xcresult \
            -test-timeouts-enabled YES \
            -maximum-test-execution-time-allowance 180 \
            -maximum-concurrent-test-simulator-destinations 1 2>&1 | tee test-output.log || UI_TEST_EXIT_CODE=$?
          
          # Always exit with the test result code
          exit ${UI_TEST_EXIT_CODE:-0}
      
      - name: Parse and Display Test Failures
        if: always()
        working-directory: MovieSearcher
        run: |
          echo "ðŸ” Analyzing UI test results..."
          echo ""
          
          # Check if result file exists
          if [ ! -d "UITestResults.xcresult" ]; then
            echo "âŒ Test results file not found!"
            echo "This usually means tests didn't start properly."
            echo ""
            echo "=== Last 50 lines of test output ==="
            tail -50 test-output.log 2>/dev/null || echo "No test output log found"
            exit 0
          fi
          
          echo "=== Test Results Analysis ==="
          echo ""
          
          # Use xcresulttool to get summary (simpler approach)
          echo "ðŸ“Š Test Summary:"
          xcrun xcresulttool get --format json --path UITestResults.xcresult 2>/dev/null | python3 << 'PYTHON_SCRIPT'
import json
import sys

try:
    data = json.load(sys.stdin)
    
    # Find test reference
    test_ref_id = None
    for action in data.get('actions', []):
        test_ref = action.get('actionResult', {}).get('testsRef', {})
        if test_ref and 'id' in test_ref:
            test_ref_id = test_ref['id'].get('_value', '')
            if test_ref_id:
                break
    
    if not test_ref_id:
        print("âš ï¸  Could not find test reference")
        sys.exit(0)
    
    print(f"Test Reference ID: {test_ref_id}")
    print("")
    
except Exception as e:
    print(f"Error reading result file: {e}")
    sys.exit(0)

PYTHON_SCRIPT

          echo ""
          echo "=== Extracting Test Details ==="
          echo ""
          
          # Extract detailed test information using xcresulttool export
          TEST_EXPORT=$(xcrun xcresulttool export --type directory --path UITestResults.xcresult --output-path /tmp/test-export 2>&1 || echo "export_failed")
          
          if [ "$TEST_EXPORT" != "export_failed" ] && [ -d "/tmp/test-export" ]; then
            echo "âœ… Successfully exported test details"
          fi
          
          # Try to get readable summary from xcresulttool
          echo "=== Test Execution Summary ==="
          xcrun xcresulttool get --format json --path UITestResults.xcresult 2>/dev/null | python3 << 'PYTHON_SCRIPT'
import json
import sys

def extract_test_results(obj, path="", failed_tests=[], passed_tests=[]):
    """Recursively extract test results from the JSON structure"""
    if isinstance(obj, dict):
        # Check if this is a test summary
        test_name_obj = obj.get('testName', {})
        test_status_obj = obj.get('testStatus', {})
        
        if test_name_obj and test_status_obj:
            test_name = test_name_obj.get('_value', '')
            test_status = test_status_obj.get('_value', '')
            duration = obj.get('duration', {}).get('_value', 0)
            
            full_name = f"{path}.{test_name}" if path else test_name
            
            if test_status == 'Success':
                passed_tests.append((full_name, duration))
            elif test_status == 'Failure':
                # Get failure message
                failure_msgs = []
                failures = obj.get('failureSummaries', {})
                if isinstance(failures, dict) and '_values' in failures:
                    for failure in failures['_values']:
                        msg = failure.get('message', {}).get('_value', '')
                        if msg:
                            failure_msgs.append(msg)
                
                failed_tests.append((full_name, duration, failure_msgs))
        
        # Recursively search in all values
        for key, value in obj.items():
            new_path = f"{path}.{key}" if path and key.startswith('_') is False else path
            extract_test_results(value, new_path, failed_tests, passed_tests)
    
    elif isinstance(obj, list):
        for item in obj:
            extract_test_results(item, path, failed_tests, passed_tests)

try:
    data = json.load(sys.stdin)
    
    failed_tests = []
    passed_tests = []
    
    extract_test_results(data, failed_tests=failed_tests, passed_tests=passed_tests)
    
    print(f"âœ… Passed Tests: {len(passed_tests)}")
    for test_name, duration in passed_tests[:10]:  # Show first 10
        print(f"   âœ“ {test_name} ({duration:.2f}s)")
    if len(passed_tests) > 10:
        print(f"   ... and {len(passed_tests) - 10} more")
    
    print("")
    print(f"âŒ Failed Tests: {len(failed_tests)}")
    for test_name, duration, messages in failed_tests:
        print(f"   âœ— {test_name} ({duration:.2f}s)")
        for msg in messages[:2]:  # Show first 2 error messages
            # Truncate long messages
            short_msg = msg[:200] + "..." if len(msg) > 200 else msg
            print(f"      {short_msg}")
    
    print("")
    print(f"ðŸ“Š Total: {len(passed_tests) + len(failed_tests)} tests")
    
except Exception as e:
    print(f"âš ï¸  Could not parse detailed results: {e}")
    print("")
    print("Raw test output summary:")
    # Fallback: try to extract from test output log
    pass

PYTHON_SCRIPT

          echo ""
          echo "=== Searching for Error Patterns in Log ==="
          if [ -f "test-output.log" ]; then
            echo ""
            echo "Key error patterns found:"
            grep -i -E "(error|fail|timeout|assert|exception)" test-output.log | head -20 || echo "No obvious error patterns found"
            
            echo ""
            echo "=== Test Execution Summary from Log ==="
            echo "Failed tests:"
            grep -E "Test case.*failed" test-output.log | sed 's/.*Test case //' | sed 's/ failed.*//' || echo "Could not extract failed test names"
            
            echo ""
            echo "Passed tests:"
            grep -E "Test case.*passed" test-output.log | sed 's/.*Test case //' | sed 's/ passed.*//' | head -10 || echo "Could not extract passed test names"
          fi
          
          echo ""
          echo "ðŸ“¥ For detailed analysis:"
          echo "   1. Download the 'ui-test-results' artifact"
          echo "   2. Extract UITestResults.xcresult"
          echo "   3. Open it in Xcode (double-click) to see full details, screenshots, and logs"
      
      - name: Generate Test Summary
        if: always()
        working-directory: MovieSearcher
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## ðŸ§ª UI Test Results
          
          EOF
          
          if [ -d "UITestResults.xcresult" ]; then
            echo "âœ… Test results file generated" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Extract summary from log if available
            if [ -f "test-output.log" ]; then
              PASSED_COUNT=$(grep -c "Test case.*passed" test-output.log 2>/dev/null || echo "0")
              FAILED_COUNT=$(grep -c "Test case.*failed" test-output.log 2>/dev/null || echo "0")
              
              echo "### Test Statistics" >> $GITHUB_STEP_SUMMARY
              echo "- âœ… Passed: $PASSED_COUNT" >> $GITHUB_STEP_SUMMARY
              echo "- âŒ Failed: $FAILED_COUNT" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              
              if [ "$FAILED_COUNT" -gt 0 ]; then
                echo "### Failed Tests" >> $GITHUB_STEP_SUMMARY
                echo '```' >> $GITHUB_STEP_SUMMARY
                grep "Test case.*failed" test-output.log | sed 's/.*Test case //' | sed 's/ failed.*//' | head -20 >> $GITHUB_STEP_SUMMARY
                echo '```' >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
              fi
            fi
            
            echo "### Download Results" >> $GITHUB_STEP_SUMMARY
            echo "Download the \`ui-test-results\` artifact and open \`UITestResults.xcresult\` in Xcode for detailed analysis." >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Test results file not found" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Tests may not have started properly. Check the logs above for errors." >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Upload Unit Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-results
          path: MovieSearcher/TestResults.xcresult
          retention-days: 30
          if-no-files-found: ignore
      
      - name: Upload UI Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ui-test-results
          path: |
            MovieSearcher/UITestResults.xcresult
            MovieSearcher/test-output.log
          retention-days: 30
          if-no-files-found: ignore
      
      - name: Cleanup simulators
        if: always()
        run: |
          echo "ðŸ§¹ Cleaning up simulators..."
          xcrun simctl shutdown all || true
          echo "âœ… Cleanup complete"
